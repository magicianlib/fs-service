<?xml version="1.0" encoding="UTF-8"?>
<Configuration status="DEBUG" packages="org.apache.logging.log4j.core.async">
    <Properties>
        <!-- 优先使用系统属性，如果系统属性不存在时再使用 Spring 配置的属性 -->
        <!-- 系统属性：java -Dlogging.file.dir=/usr/local/log/ -jar app.jar -->
        <Property name="APP_ID">${spring:spring.application.name}</Property>
        <Property name="LOG_FILE_DIR">${sys:logging.file.dir:-${spring:logging.file.dir}}</Property>
        <Property name="PATTERN">%date [%thread] %-5level %logger{40}%notEmpty{ [%X{logPrefix}]}%notEmpty{ [%X{traceId}]} - %msg%n</Property>
    </Properties>
    <Appenders>
        <!-- 控制台输出 -->
        <Console name="Console" target="SYSTEM_OUT">
            <PatternLayout pattern="${PATTERN}"/>
        </Console>

        <!-- 业务日志 -->
        <RollingFile name="BizAppender">
            <!-- 输出文件 -->
            <FileName>${LOG_FILE_DIR}/${APP_ID}/app.log</FileName>
            <FilePattern>${LOG_FILE_DIR}/${APP_ID}/app.log.%d{yyyy-MM-dd}-%i.gz</FilePattern>

            <!-- 输出格式 -->
            <PatternLayout pattern="${PATTERN}"/>

            <!-- 滚动策略 -->
            <Policies>
                <!-- 每天新文件 -->
                <TimeBasedTriggeringPolicy/>
                <!-- 超过 10MB 滚动 -->
                <SizeBasedTriggeringPolicy size="10MB"/>
            </Policies>

            <!-- 保留策略 -->
            <DefaultRolloverStrategy max="30"/>
        </RollingFile>

        <!-- 错误日志 -->
        <RollingFile name="ErrorAppender">
            <!-- 输出文件 -->
            <FileName>${LOG_FILE_DIR}/${APP_ID}/error.log</FileName>
            <FilePattern>${LOG_FILE_DIR}/${APP_ID}/error.log.%d{yyyy-MM-dd}-%i.gz</FilePattern>

            <!-- 输出格式 -->
            <PatternLayout pattern="${PATTERN}"/>

            <!-- 滚动策略 -->
            <Policies>
                <!-- 每天新文件 -->
                <TimeBasedTriggeringPolicy/>
                <!-- 超过 10MB 滚动 -->
                <SizeBasedTriggeringPolicy size="10MB"/>
            </Policies>

            <!-- 保留策略 -->
            <DefaultRolloverStrategy max="30"/>
        </RollingFile>
    </Appenders>

    <Loggers>
        <!-- additivity=false 用于控制防止日志同时写到父 logger，只写到指定文件 -->

        <!-- Hibernate SQL 日志 -->
        <Logger name="org.hibernate.SQL" level="INFO" additivity="false">
            <AppenderRef ref="Console"/>
        </Logger>

        <!-- Hikari 连接池 -->
        <Logger name="com.zaxxer.hikari" level="INFO" additivity="false">
            <AppenderRef ref="Console"/>
        </Logger>

        <!-- Spring 框架 -->
        <Logger name="org.springframework" level="INFO"/>

        <!-- 根日志（项目日志） -->
        <Root level="INFO">
            <AppenderRef ref="Console"/>
            <AppenderRef ref="BizAppender"/>
            <AppenderRef ref="ErrorAppender"> <!-- 错误日志额外输出一份 -->
                <!-- 只接受 ERROR 级别及以上的日志 -->
                <Filters>
                    <ThresholdFilter level="error" onMatch="ACCEPT" onMismatch="DENY"/>
                </Filters>
            </AppenderRef>
        </Root>
    </Loggers>
</Configuration>